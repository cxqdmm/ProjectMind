## 目标
- 将当前服务端代码重构为清晰的分层与模块化结构，降低耦合、提升可维护性与扩展性
- 单模块单文件，职责明确，包含必要注释与输入校验
- 完全采用 OpenSkills 的系统提示（AGENTS.md），保留 CALL_JSONS 解析作为固定调用结构

## 总体架构
- 路由层：只负责 HTTP 路由与入参校验，调用业务服务
- 业务服务层：封装技能读取、提示构建、推理执行、工具路由等业务逻辑
- 基础设施层：提供 LLM 提供商适配、文件与路径工具、配置读取、日志与错误处理
- 运行入口：统一创建与启动 Express 应用，注册中间件与路由

## 目录结构
- server/
  - app.js：应用入口，创建 Express、注册中间件与路由、启动服务
  - routes/
    - skills.js：GET /api/skills/manifest、/load、/reference
    - agent.js：POST /api/agent/run
  - services/
    - skillsService.js：技能目录解析、SKILL.md 与 references 读取、OpenSkills CLI 优先
    - promptService.js：读取 AGENTS.md（或构建 fallback 的 <skills_system>）
    - agentService.js：推理主循环、消息注入、会话历史维护
    - toolInvokeService.js：固定结构的工具路由（openskills.read/readReference）
    - toolParseService.js：CALL_JSONS 解析（后续可扩展支持 Anthropic 原生 tool_use）
    - providerService.js：LLM 提供商封装（Qwen），统一 chat(messages, apiKey)
  - middlewares/
    - errorHandler.js：全局错误处理中间件，输出一致的 JSON 错误结构
  - utils/
    - fsUtils.js：readFileSafe、listDirs、parseFrontmatter、路径安全检查
    - config.js：端口、llm.json 路径、环境变量读取
    - logger.js：轻量日志（info/error）

## 模块职责与接口
- skillsService
  - resolveSkillDir(name)：按优先级返回技能目录（server/skills → .agent/skills → .claude/skills → frontend/src/skills）
  - scanSkills()：返回 {key,name,description} 列表
  - loadSkill(name)：优先使用 CLI `openskills read <name>`，失败后读文件；返回 {key,meta,body}
  - loadReference(name,file)：安全拼接路径并读取；返回 {file,content}
- promptService
  - readAgentsPrompt()：读取项目根目录 AGENTS.md 的 <skills_system>；若缺失则构建 fallback 提示（与当前保持一致）
- toolParseService
  - parseToolCalls(text)：匹配 CALL_JSONS:[...]
  - 预留：parseAnthropicToolUse(blocks)（后续需要时支持）
- toolInvokeService
  - invoke(provider, tool, input)：支持 'openskills.read' 与 'openskills.readReference'，调用 skillsService；统一返回 {result}
- providerService
  - createProvider(config)：封装 Qwen chat
- agentService
  - run(userInput, apiKey)：
    - 读取系统提示（promptService）并注入到 messages
    - 推理循环：provider.chat → toolParseService.parse → toolInvokeService.invoke → 注入技能正文/引用 → 继续推理 → 返回 {reply, toolCalls, steps}
    - 维护会话历史（内存 Map，或后续抽取到 store）

## 路由实现
- skills 路由（skills.js）
  - GET /api/skills/manifest：调用 skillsService.scanSkills → 返回 {skills}
  - GET /api/skills/load：zod 校验参数 → skillsService.loadSkill → 返回 {key,meta,body}
  - GET /api/skills/reference：zod 校验参数 → skillsService.loadReference → 返回 {key,extras}
- agent 路由（agent.js）
  - POST /api/agent/run：zod 校验 {userInput,apiKey} → agentService.run → 返回 {reply,toolCalls,steps}

## 中间件与工具
- errorHandler：捕获路由异常与未处理错误，统一返回 {error:{code,message}}，避免 Express 默认错误页
- fsUtils.parseFrontmatter：兼容简单 YAML 风格；保留与现状一致的键值解析
- config：读取 llm.json、端口；后续支持环境变量覆盖（如 QWEN_API_KEY）

## 渐进迁移
- 迁移现有 server.js 中逻辑到上述模块
- 保留现有功能等价行为（CLI 优先、目录回退、CALL_JSONS 解析与工具路由）
- 移除重复实现（已在 server/lib 的多处功能，将统一抽到 services/utils）

## 注释与代码风格
- 在每个模块文件顶部添加简要模块说明（1-2 行）
- 关键函数添加 JSDoc 风格注释（参数、返回值、错误说明）
- 保持无敏感信息日志；错误消息不暴露文件系统细节

## 验证与兼容
- curl 验证三条技能 API
- 通过前端调用 POST /api/agent/run，观察技能加载与回复
- 若系统存在 OpenSkills CLI，则 CLI 优先；不存在时无错误中断，回退到目录读取

## 后续扩展（可选）
- 增加 Anthropic 原生 tool_use 解析支持（双协议识别）
- 引入更完善的 frontmatter 解析库（如 gray-matter）
- 会话历史持久化（文件/SQLite）

## 执行
- 我将按以上结构创建/迁移文件，替换 server.js 入口为 app.js，并确保所有路由与服务在新架构下通过测试。请确认后我开始实施。