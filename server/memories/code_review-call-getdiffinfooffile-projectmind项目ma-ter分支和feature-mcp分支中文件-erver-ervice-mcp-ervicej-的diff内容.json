{
  "toolName": "call",
  "type": "call",
  "content": "{\n  \"filename\": \"server/services/mcpService.js\",\n  \"content\": \"diff --git a/server/services/mcpService.js b/server/services/mcpService.js\\nnew file mode 100644\\nindex 0000000..9a839b3\\n--- /dev/null\\n+++ b/server/services/mcpService.js\\n@@ -0,0 +1,103 @@\\n+\\n+import { Client } from \\\"@modelcontextprotocol/sdk/client/index.js\\\"\\n+import { StdioClientTransport } from \\\"@modelcontextprotocol/sdk/client/stdio.js\\\"\\n+import { getMcpServers } from \\\"../utils/mcpConfig.js\\\"\\n+\\n+// 存储已连接的 client 实例\\n+const clients = new Map()\\n+// 存储所有可用工具的定义\\n+let cachedTools = []\\n+\\n+/**\\n+ * 初始化所有 MCP 连接\\n+ */\\n+export async function initMcpClients() {\\n+  const servers = getMcpServers()\\n+  for (const [name, config] of Object.entries(servers)) {\\n+    if (clients.has(name)) continue\\n+    \\n+    try {\\n+      const transport = new StdioClientTransport({\\n+        command: config.command,\\n+        args: config.args || []\\n+      })\\n+      \\n+      const client = new Client({\\n+        name: \\\"ProjectMind-Client\\\",\\n+        version: \\\"1.0.0\\\"\\n+      }, {\\n+        capabilities: {}\\n+      })\\n+      \\n+      await client.connect(transport)\\n+      clients.set(name, client)\\n+      console.log(`[MCP] Connected to server: ${name}`)\\n+    } catch (e) {\\n+      console.error(`[MCP] Failed to connect to ${name}:`, e)\\n+    }\\n+  }\\n+}\\n+\\n+/**\\n+ * 获取所有已连接 Server 的工具列表\\n+ * 并转换为 OpenAI/GLM 兼容的 Tool 格式\\n+ */\\n+export async function getMcpTools() {\\n+  // 如果已经有缓存且连接数没变，直接返回（简单缓存策略）\\n+  // 实际场景可能需要定期刷新\\n+  if (cachedTools.length > 0 && cachedTools.length >= clients.size) {\\n+    return cachedTools\\n+  }\\n+\\n+  const allTools = []\\n+  \\n+  for (const [serverName, client] of clients.entries()) {\\n+    try {\\n+      const { tools } = await client.listTools()\\n+      for (const t of tools) {\\n+        allTools.push({\\n+          type: 'function',\\n+          function: {\\n+            name: t.name,\\n+            description: t.description,\\n+            parameters: t.inputSchema\\n+          },\\n+          // 内部标记，用于执行时路由\\n+          __mcpServer: serverName\\n+        })\\n+      }\\n+    } catch (e) {\\n+      console.error(`[MCP] Failed to list tools from ${serverName}:`, e)\\n+    }\\n+  }\\n+  \\n+  cachedTools = allTools\\n+  return allTools\\n+}\\n+\\n+/**\\n+ * 调用 MCP 工具\\n+ */\\n+export async function callMcpTool(toolName, args) {\\n+  // 找到该工具所属的 server\\n+  const toolDef = cachedTools.find(t => t.function.name === toolName)\\n+  if (!toolDef || !toolDef.__mcpServer) {\\n+    throw new Error(`MCP tool ${toolName} not found or server unknown`)\\n+  }\\n+  \\n+  const serverName = toolDef.__mcpServer\\n+  const client = clients.get(serverName)\\n+  if (!client) {\\n+    throw new Error(`MCP server ${serverName} not connected`)\\n+  }\\n+  \\n+  try {\\n+    const result = await client.callTool({\\n+      name: toolName,\\n+      arguments: args\\n+    })\\n+    return result\\n+  } catch (e) {\\n+    throw new Error(`MCP tool execution failed: ${e.message}`)\\n+  }\\n+}\",\n  \"originalContent\": \"\",\n  \"newContent\": \"import { Client } from \\\"@modelcontextprotocol/sdk/client/index.js\\\"\\nimport { StdioClientTransport } from \\\"@modelcontextprotocol/sdk/client/stdio.js\\\"\\nimport { getMcpServers } from \\\"../utils/mcpConfig.js\\\"\\n\\n// 存储已连接的 client 实例\\nconst clients = new Map()\\n// 存储所有可用工具的定义\\nlet cachedTools = []\\n\\n/**\\n * 初始化所有 MCP 连接\\n */\\nexport async function initMcpClients() {\\n  const servers = getMcpServers()\\n  for (const [name, config] of Object.entries(servers)) {\\n    if (clients.has(name)) continue\\n    \\n    try {\\n      const transport = new StdioClientTransport({\\n        command: config.command,\\n        args: config.args || []\\n      })\\n      \\n      const client = new Client({\\n        name: \\\"ProjectMind-Client\\\",\\n        version: \\\"1.0.0\\\"\\n      }, {\\n        capabilities: {}\\n      })\\n      \\n      await client.connect(transport)\\n      clients.set(name, client)\\n      console.log(`[MCP] Connected to server: ${name}`)\\n    } catch (e) {\\n      console.error(`[MCP] Failed to connect to ${name}:`, e)\\n    }\\n  }\\n}\\n\\n/**\\n * 获取所有已连接 Server 的工具列表\\n * 并转换为 OpenAI/GLM 兼容的 Tool 格式\\n */\\nexport async function getMcpTools() {\\n  // 如果已经有缓存且连接数没变，直接返回（简单缓存策略）\\n  // 实际场景可能需要定期刷新\\n  if (cachedTools.length > 0 && cachedTools.length >= clients.size) {\\n    return cachedTools\\n  }\\n\\n  const allTools = []\\n  \\n  for (const [serverName, client] of clients.entries()) {\\n    try {\\n      const { tools } = await client.listTools()\\n      for (const t of tools) {\\n        allTools.push({\\n          type: 'function',\\n          function: {\\n            name: t.name,\\n            description: t.description,\\n            parameters: t.inputSchema\\n          },\\n          // 内部标记，用于执行时路由\\n          __mcpServer: serverName\\n        })\\n      }\\n    } catch (e) {\\n      console.error(`[MCP] Failed to list tools from ${serverName}:`, e)\\n    }\\n  }\\n  \\n  cachedTools = allTools\\n  return allTools\\n}\\n\\n/**\\n * 调用 MCP 工具\\n */\\nexport async function callMcpTool(toolName, args) {\\n  // 找到该工具所属的 server\\n  const toolDef = cachedTools.find(t => t.function.name === toolName)\\n  if (!toolDef || !toolDef.__mcpServer) {\\n    throw new Error(`MCP tool ${toolName} not found or server unknown`)\\n  }\\n  \\n  const serverName = toolDef.__mcpServer\\n  const client = clients.get(serverName)\\n  if (!client) {\\n    throw new Error(`MCP server ${serverName} not connected`)\\n  }\\n  \\n  try {\\n    const result = await client.callTool({\\n      name: toolName,\\n      arguments: args\\n    })\\n    return result\\n  } catch (e) {\\n    throw new Error(`MCP tool execution failed: ${e.message}`)\\n  }\\n}\",\n  \"stats\": {\n    \"additions\": 103,\n    \"deletions\": 0,\n    \"status\": \"added\"\n  },\n  \"summary\": {\n    \"additions\": 103,\n    \"deletions\": 0,\n    \"totalChanges\": 103,\n    \"status\": \"added\"\n  },\n  \"desc\": \"ProjectMind 项目 master 分支和 feature/mcp 分支中文件 server/services/mcpService.js 的 diff 内容\"\n}",
  "snippet": "ProjectMind 项目 master 分支和 feature/mcp 分支中文件 server/services/mcpService.js 的 diff 内容",
  "skill": "code_review",
  "skillDescription": "",
  "script": "scripts/getDiffinfoOfFile.js",
  "createdAt": 1768285153179,
  "updatedAt": 1768285153179,
  "meta": {
    "name": "",
    "description": "",
    "type": "object",
    "desc": "ProjectMind 项目 master 分支和 feature/mcp 分支中文件 server/services/mcpService.js 的 diff 内容"
  },
  "deprecated": false
}